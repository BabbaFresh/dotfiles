#!/bin/sh

smb_username=""
smb_password=""
smb_host=""
configfile=$HOME/.smbutilsrc

if [ "$#" -ne 1 ] && [ "$#" -ne 2 ];
then
    echo "Illegal number of parameters"
    exit
fi

if [ -r $configfile ]; then
    # check if the file contains something we don't want
    if egrep -q -v '^#|^[^ ]*=[^;]*' "$configfile"; then
      echo "Config file is unclean, cleaning it..." >&2
      # filter the original to a new file
      egrep '^#|^[^ ]*=[^;&]*'  "$configfile" > "$configfile_secured"
      configfile="$configfile_secured"
    fi

    # now source it, either the original or the filtered variant
    source "$configfile"
fi

if [ $1 = "info" ];
then
    if [ $smb_username = "" ];
    then
        echo 'Enter Username (e.g.: koelngofeminin\\walialu)'
        read smb_username
    fi

    if [ $smb_domain = "" ];
    then
        echo 'Enter Domain (e.g. koelngofeminin)'
        read smb_domain
    fi

    if [ $smb_host = "" ];
    then
        echo 'Enter SMB Hostname/IP (e.g.: gofeminincloud)'
        read smb_host
    fi

    if [ $smb_username != "" ];
    then
        if [ $smb_password != "" ];
        then
            smbclient -L //${smb_host} -U${smb_domain}\\${smb_username}
        else
            smbclient -L //${smb_host} -U${domain}\\${smb_username}%"${smb_password}"
        fi
    fi
fi

if [ $1 = "mount" ];
then
    if [ $smb_username = "" ];
    then
        echo 'Enter Username (e.g. walialu)'
        read smb_username
    fi

    if [ $smb_host = "" ];
    then
        echo 'Enter SMB Location (e.g.: gofeminincloud/design)'
        read smb_host
        smb_mountpath=$HOME/SambaShares/$(echo $smb_host|cut -d'/' -f 2-)
    else
        if [ "$#" -ne 1 ];
        then
            smb_mountpoint=$2
        else
            echo 'Enter SMB Location (e.g.: design)'
            read smb_mountpoint
        fi
        smb_mountpath=$HOME/SambaShares/$smb_mountpoint
    fi

    if [ $smb_username != "" ];
    then
        mkdir -p $smb_mountpath

        if [ "$smb_password" = "" ];
        then
            sudo mount -t cifs //${smb_host}/$smb_mountpoint $smb_mountpath -o username=${smb_username}
        else
            sudo mount -t cifs //${smb_host}/$smb_mountpoint $smb_mountpath -o username=${smb_username},password="${smb_password}"
        fi
    fi
fi

if [ $1 = "unmount" ] || [ $1 = "umount" ];
then
    if [ "$#" -ne 1 ];
    then
        smb_mountpoint=$2
    else
        echo 'Enter Mountpoint (e.g.: design)'
        read smb_mountpoint
    fi
    smb_mountpath=$HOME/SambaShares/$smb_mountpoint
    sudo umount $smb_mountpath
fi

if [ $1 = "mounthelp" ];
then
    echo 'https://wiki.archlinux.de/title/Laufwerk_als_User_mounten#Mit_sudo'
fi
